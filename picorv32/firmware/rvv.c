// ajoute par Adrien

#include <riscv_vector.h>

#include "firmware.h"

/* void rvv(void) {
  int16_t a[8], b[8], c[8];

  // init
  int16_t acc = 0;
  for (int i = 0; i < 8; i++) {
    a[i] = i;
    acc += i;
    b[i] = acc;
  }

  // vector
  // doesn't work with an odd number of compressable instructions padding if
  // it's compiled supporting compressed insn
  __asm__ volatile(
      "vsetvli t0, x0, e16, m1\n"
      "vle16.v v0, (%0)\n"
      "vle16.v v1, (%1)\n"
      "vadd.vv v2, v0, v1\n"
      "vse16.v v2, (%2)\n"
      :
      : "r"(a), "r"(b), "r"(c)
      : "t0", "v0", "v1", "v2");

  for (int i = 0; i < 8; i++) {
    print_str("(scalar, vector) : ");
    print_dec(a[i] + b[i]);
    print_str(" ");
    print_dec(c[i]);
    print_str("\n");
    if (c[i] != a[i] + b[i]) {
      print_str("ERROR !\n");
      __asm__ volatile("ebreak");
      return;
    }
  }

  print_str("RVV from C..OK\n");
} */

unsigned a[256] = {
    3754790806, 1113737291, 2222265960, 24565879,   1337621970, 888921788,
    2482653588, 151029862,  1794356460, 464234861,  4011473426, 2947702016,
    3858430419, 4280213416, 621767873,  3424026707, 4123972446, 1861526824,
    120687365,  3327829515, 795027032,  2359891284, 1553156270, 458742262,
    3163727453, 109246090,  3893604901, 17230625,   2363881017, 2869354622,
    222333585,  3560327407, 1125570196, 2775344010, 596730897,  1664420886,
    746020919,  881959493,  81275244,   3073970187, 1322164727, 365697698,
    2925994675, 2964310022, 1683454879, 740815164,  2421501306, 2278709701,
    2449677736, 1239196726, 2099519969, 4195959732, 2946748321, 2396312256,
    3571544004, 34068886,   3179832267, 754812716,  2564165543, 1806611778,
    3362261947, 2036025460, 962970679,  718919270,  2965979564, 281992125,
    686534268,  2181081689, 431019812,  3048363240, 3147112996, 22915141,
    843257300,  2141222351, 1890737734, 2545189962, 3784110714, 4020284792,
    1365494482, 295989719,  696601327,  1536336312, 3363658117, 2618629131,
    743161566,  3261490990, 2149690836, 1472854637, 559620947,  4184867175,
    3378215270, 2354803077, 3031363777, 1259363476, 697853529,  1497008972,
    1403301173, 3006047901, 2511939903, 2397077484, 479628016,  3134877342,
    909291917,  1179496010, 2751691392, 1004133414, 3615449253, 3420551631,
    1315873571, 3511144641, 2150592185, 3827386062, 4260662085, 1871302761,
    947494745,  3348115439, 2370355868, 145364576,  3000030600, 1288374310,
    3697801466, 3344470011, 1258618493, 3708428706, 572542410,  1588633221,
    70057519,   3515955744, 2966650550, 785822164,  3355637082, 2118480931,
    2320707863, 1214597403, 3552884784, 1454020025, 4152108983, 2784422576,
    2035009217, 2152336190, 3581516587, 1435651877, 1565300262, 2931895261,
    2117291513, 3968760380, 2132330483, 3513754264, 1409434002, 474778604,
    2402750508, 525360747,  3611481642, 4059128196, 2247527489, 4088121105,
    1526383487, 1885136622, 148178674,  1074398317, 2837831872, 570359486,
    1502074490, 500008133,  2205888013, 2384025891, 1079535117, 2571477167,
    2335839293, 2453200232, 3846644410, 2482933100, 1798199413, 3418476097,
    488155495,  2286505164, 1662935563, 2788767950, 4192394826, 1896838614,
    3233828135, 2191810258, 1435922128, 409021901,  3682273461, 1550880874,
    2312120262, 892949125,  3013506661, 1556646842, 1850644098, 618747550,
    326470303,  1494929773, 3671212221, 2873475502, 981384938,  1377281106,
    2002178939, 845382223,  1595022391, 397054172,  2946027237, 2683064584,
    1687323833, 3148518543, 1571572100, 2935612088, 299227346,  4079724387,
    2161920724, 2020213552, 3141003480, 2959225878, 2521352,    3539167249,
    609741581,  509070060,  224636635,  1690000491, 1478995140, 2851859412,
    3252241608, 2421738259, 3662124375, 1464203023, 481034897,  1682106118,
    2402522889, 3446724269, 4160594496, 32331701,   60095923,   3317752931,
    1760892005, 2372385274, 1577135769, 3587039916, 2342224748, 4223149133,
    1872129166, 2094837185, 3981273844, 2094998347, 3950776562, 1566584503,
    4144001342, 1948270593, 3163382870, 4146655948, 2627227897, 1970583909,
    2211057653, 800379130,  3005266496, 587484654};

unsigned b[256] = {
    2729881765, 705034318,  3465466561, 2348260339, 45218884,   1870922164,
    1120282178, 2336050904, 1192202458, 2436734399, 4005317031, 3606356240,
    3445236822, 1514720154, 670594661,  3163764541, 4062136299, 310309476,
    4104681820, 1658940024, 1234842990, 3103414731, 3729375152, 1057124096,
    3681896413, 3467889486, 3691102355, 799151807,  2322420200, 2777345536,
    655853510,  3955322132, 2534120506, 4101252275, 2558950100, 2028028877,
    2763545007, 3441425375, 3483544403, 1616154759, 3850093692, 2643285703,
    4234514001, 823818130,  2534351762, 4058185589, 3536852509, 731011189,
    2442525605, 794667136,  4155202969, 4294749288, 3107170348, 795682914,
    2420126589, 1702176239, 368188961,  2791777168, 2250226984, 2912152621,
    222175550,  3880403759, 4238452547, 3446590818, 1966294506, 1252457061,
    3668720884, 989290310,  3253107511, 3766056848, 3764326814, 1635643562,
    365774784,  4048128670, 4095373724, 916610481,  633925578,  3164203996,
    2834807328, 1170190761, 2542193853, 1533898165, 3277787933, 3710512185,
    156001500,  3231074160, 433836992,  1934046290, 3358207752, 658433714,
    1561187935, 2813231629, 1671849274, 3067657379, 4285566873, 3847315221,
    491297647,  2706558050, 3675322137, 3876192978, 2146996456, 3404938895,
    684987442,  3973497969, 3371914574, 3767881415, 3134050522, 4287031633,
    2849199301, 770374638,  566442176,  353577104,  3393412493, 2969070722,
    2326266187, 2816235252, 4216981962, 2805046897, 3503731792, 961724553,
    695643041,  204549689,  3690648466, 2195525964, 1977113921, 640597811,
    3113294585, 1739210474, 3008535975, 2985248265, 1849774286, 2372702259,
    3938073385, 280012528,  1809822208, 2881438397, 4139928689, 1188811705,
    683466549,  523658830,  2318840916, 3099979909, 1699023876, 367752819,
    1137803825, 2107349515, 44332317,   756401299,  3126693591, 1762051475,
    685866859,  3469313455, 2582135403, 2832994483, 2047504428, 2320999603,
    3767161922, 535036923,  1446160160, 2019780040, 3922863522, 3398815699,
    590962770,  1926626070, 3984458617, 786862953,  955275121,  3688220172,
    3348905474, 1729344654, 3606392064, 19928580,   799814377,  2892726875,
    122014272,  3788094360, 3885211777, 2037591952, 2268910583, 1417550823,
    279387634,  3194721277, 1111696104, 3570800591, 1868267815, 3555453444,
    3772614227, 1441954143, 2507917455, 1536132975, 2081613838, 3140932907,
    853520536,  2472736697, 3586280390, 1874588187, 3984762077, 1481974121,
    963774649,  387709425,  1859306037, 3327460219, 3669766231, 3075449651,
    3181459323, 3874027940, 536610409,  2227974291, 1591581754, 3935421915,
    3285178971, 1523121915, 230455805,  3876955163, 3562299073, 3687971091,
    1856829667, 3924074078, 3827944044, 976669942,  3869216744, 3591835726,
    1556218922, 233825709,  3874716736, 2575069618, 971644128,  1488318477,
    1454413783, 145364029,  3902343700, 3743157068, 1758575281, 10010734,
    2770772360, 2163359170, 2702762256, 104121330,  3546786781, 199468272,
    859785669,  150562963,  2457800418, 3066171561, 3608537037, 2290770958,
    593386788,  2778214110, 3846441855, 538956543,  15248731,   3881892386,
    1586613583, 3342624202, 3721345997, 4204378537};

/* unsigned a[64] = {41789, 124905, 18959,  107119, 81732, 75405, 116300, 38509,
                  37305, 8326,   47580,  117410, 96400, 72379, 108173, 79788,
                  36812, 89807,  84039,  118985, 41900, 18208, 88134,  113440,
                  40693, 27816,  26276,  67064,  82223, 2354,  8972,   106781,
                  62908, 29155,  111258, 28339,  41911, 60920, 34087,  10145,
                  49212, 117453, 32851,  31201,  43203, 33226, 86319,  79738,
                  78191, 127333, 67847,  102162, 87028, 34179, 33320,  33386,
                  76370, 40022,  21571,  34629,  89861, 48096, 92681,  22464};
unsigned b[64] = {62908, 29155,  111258, 28339,  41911, 60920, 34087, 10145,
                  49212, 117453, 32851,  31201,  43203, 33226, 86319, 79738,
                  78191, 127333, 67847,  102162, 87028, 34179, 33320, 33386,
                  76370, 40022,  21571,  34629,  89861, 48096, 92681, 22464,
                  62908, 29155,  111258, 28339,  41911, 60920, 34087, 10145,
                  49212, 117453, 32851,  31201,  43203, 33226, 86319, 79738,
                  78191, 127333, 67847,  102162, 87028, 34179, 33320, 33386,
                  76370, 40022,  21571,  34629,  89861, 48096, 92681, 22464}; */

void rvv(void) {
  unsigned c1[256], c2[256], c3[256];
  unsigned int num_cycles1, num_cycles2;
  __asm__ volatile("rdcycle %0;" : "=r"(num_cycles1));

  for (int i = 0; i < 256; i++) {
    c1[i] = a[i] + b[i];
    c2[i] = c1[i] >> 2;
    c3[i] = c2[i] + 5;
  }

  __asm__ volatile("rdcycle %0;" : "=r"(num_cycles2));

  print_str("Sum took ");
  print_dec(num_cycles2 - num_cycles1);
  print_str(" cycles\n");

  for (int i = 0; i < 256; i++) {
    print_dec(a[i]);
    print_str(" + ");
    print_dec(b[i]);
    print_str(" = ");
    print_dec(c1[i]);
    print_str("\n");

    print_dec(c1[i]);
    print_str(" >> 2 = ");
    print_dec(c2[i]);
    print_str("\n");

    print_dec(c2[i]);
    print_str(" + 5 = ");
    print_dec(c3[i]);
    print_str("\n\n");
  }

  return;
}